# Rendering Pipeline

+ https://www.youtube.com/watch?v=qHpKfrkpt4c

## 데이터 로드 단계

1. 실행중인 응용 프로그램이 메쉬(Mesh)를 로드하고 렌더링 할 것을 요청한다.
2. 엔진(유니티) 혹은 응용 프로그램은 디스크에 메쉬를 RAM에 로드하라고 요청한다.
3. RAM에 로드된 메쉬는 특정한 정보(메쉬 정보)의 형태로 로드가 된다.

## CPU와 GPU

1. CPU는 GPU와 통신을 할 때 명령 버퍼(Command Buffer)라는 큐 형태를 통해 수행된다.
2. CPU가 GPU에게 '무언가를 그려라!' 라고 하는 요청은 2 단계로 나뉘고, 첫 번째가 RenderState 설정, 두 번째는 메쉬 그리기 단계이다.

### RenderState

RenderState는 이하의 정보를 포함하고 있고, 해당 정보들의 세팅이 완료되면 '메쉬 그리기' 명령을 수행 할 수 있다.

+ 정점 쉐이더(Vertex Shader)
+ 픽쉘 쉐이더(Pixel Shader) / Fragment Shader
+ 텍스쳐(Texture)
+ 조명 설정(Lighting Setting)

### 메쉬 그리기

메쉬 그리기를 수행하게 되면 텍스처 및 메쉬의 정보가 VRAM(GPU의 RAM)에 전송되고 해당 정보를 기반으로 '그리기'를 수행한다.

+ 같은 RenderState 정보를 사용하는 Mesh는 RenderState를 설정할 필요 없이 바로 '그리기'가 가능하다.
+ 여기서 '그리기' 라는 작업을 DrawCall이라고 부르고, 동일한 RenderState를 사용하는 메쉬에 대해 하나의 DrawCall로 묶는 작업을 Batching이라고 한다.

#### 정점 쉐이더(Vertex Shader)

'메쉬 그리기' 명령을 실행하면 제일 먼저 정점 쉐이더가 실행 되고, 쉐이더는 메쉬에게서 아래의 정보들을 읽어들인다.

+ 정점 위치(Vertex Position)
+ 법선(Normal)
+ 탄젠트(Tangent)

그리고 얻은 정보를 토대로 물체의 좌표 공간을 변환한다.

+ 월드 공간(World Space)
+ 뷰 공간(View Space)
+ 투영 공간(Projection Space)

이로서 카메라에 기반한 투영 공간 행렬을 얻게 되고, 래스터라이저에게 정보를 보낼 준비를 마친다.

#### 컬링(추려내기 / Culling)

래스터라이저에게 정보를 보내기 전, 선택적인 단계가 존재하고 이 단계를 컬링이라고 한다.

컬링은 정면(Front Face)와 후면(Back Face)로 나뉘어지고, 시계 방향으로 수집된 메쉬의 정보가 정면, 반시계 방향이 후면이다.

컬링 단계에서는 렌더링 할 때 어느 한쪽의 정보를 무시하여 다른 한쪽 면만 렌더링 할 수 있도록 한다. 보통 기본으로 후면이 무시된다.

그다음 래스터라이즈 프로세스에 들어선다.

#### 래스터라이저(Rasterizer)

래스터라이즈는 표준화된 화면 공간에 기반하여 메쉬를 그릴때 어떤 픽셀을 사용하여 화면에 그릴지를 결정한다.

이 과정에서 클리핑(Clliping)이 일어나 메쉬가 투영되는 화면 바깥에 있는 부분은 무시하게 된다.

그리고 버텍스 쉐이더에서 받은 정보를 보간하여 픽셀 셰이더로 보낸다.

#### 픽셀 셰이더(Pixel Shader / Fragment Shader)

픽셀 셰이더(또는 조각 셰이더)는 한 픽셀의 컬러, 알파, z-깊이(z-depth) 데이터를 결정한다.

그리고 z-test(depth test)라고 하는 z-깊이 데이터를 갱신하는 테스트를 진행하고, 통과하지 못한다면 해당 픽셀은 폐기된다.

#### Blending

z-깊이 테스트를 통과했다면 선택적 단계인 Blending이라는 단계가 존재한다.

이 단계는 알파값을 이용해서 색상을 어떻게 섞을 것인가를 결정하는 단계이다.

#### Stencil Test

Blending 단계 이후 스텐실 테스트라는 선택적 단계가 또 있다.

스텐실 테스트는 장면의 렌더링 영역을 제한하고자 할 때 사용, 즉 특정 영역만 렌더링 할 수 있다.

#### Color Mask

스텐실 테스트를 통과하면 컬러 마스크라고 하는 선택적 단계가 또 존재한다.
해당 단계는 특정 컬러 채널을 무시할 수 있고,

컬러 마스크를 통과한 최종 색이 컬러 버퍼 / 프레임 버퍼로 간다.
